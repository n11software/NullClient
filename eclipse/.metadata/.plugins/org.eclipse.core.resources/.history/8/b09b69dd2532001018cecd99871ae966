package n11client;

import n11client.utils.Log;
import n11client.utils.SessionChanger;
import net.minecraft.client.Minecraft;
import net.minecraft.client.gui.GuiLogin;
import net.minecraft.client.gui.GuiMainMenu;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

public class Login {

    private static Process browser = null;
    public static String Token = "";
    public static String UUID = "";
    public static String Username = "";
    public static boolean done = false;

    public static void getSessionMicrosoft() throws Exception {
        HTTPServer.start();
        Runtime rt = Runtime.getRuntime();
        String url = "https://login.live.com/oauth20_authorize.srf?client_id=6c5ec31a-2630-458e-bf5e-eca4db7f1f5d&response_type=code&redirect_uri=http://localhost:25564/&scope=XboxLive.signin%20offline_access&prompt=login";
        browser = rt.exec("rundll32 url.dll,FileProtocolHandler " + url);
    }
    public File configFile;

    public static void microsoftLoginDone(String Token, String UUID, String Username, GuiLogin loginGUI) throws IOException {
        browser.destroyForcibly();
        Login.Token = Token;
        Login.UUID = UUID;
        Login.Username = Username;
        SessionChanger.getInstance().setUser(Login.Username, Login.Token, Login.UUID);
        // save the token to a file
		File tokenFile = new File(Minecraft.getMinecraft().mcDataDir, "n11client_token.txt");
		if (tokenFile.exists()) {
			tokenFile.createNewFile();
			// save the Username, Token and UUID to the file
			String tokenData = "Username: " + Login.Username + "\nToken: " + Login.Token + "\nUUID: " + Login.UUID;
			try (OutputStream os = new FileOutputStream(tokenFile)) {
				os.write(tokenData.getBytes(StandardCharsets.UTF_8));
			}
			System.out.println("Token saved to " + tokenFile.getAbsolutePath());
		}
        loginGUI.MSCB();
        done = true;
    }
}
